---
version: "3.8"

services:
  mc:
    image: 'itzg/minecraft-server:latest'
    ports:
      - '25565:25565'
      - '24454:24454/udp'
    environment:
      DIFFICULTY: 'hard'
      ENABLE_ROLLING_LOGS: 'TRUE'
      EULA: "TRUE"
      INIT_MEMORY: '1G'
      MAX_MEMORY: '8G'
      MODRINTH_LOADER: 'FABRIC'
      MODRINTH_PROJECT: 'allexio-create+'
      MODRINTH_VERSION: '1.0.0'
      OPS: "egut"
      SEED: '20231024'
      SERVER_NAME: "Allexio's Create Plus"
      MOTD: "Allexio's Create Plus"
      SIMULATION_DISTANCE: 16
      TYPE: 'MODRINTH'
      USE_AIKAR_FLAGS: 'TRUE'
      VANILLATWEAKS_SHARECODE: 'ilFuDN'
      VERSION: "1.20.1"
      VIEW_DISTANCE: 24
      ENABLE_WHITELIST: 'TRUE'

    tty: true
    stdin_open: true
    restart: 'unless-stopped'
    volumes:
      - './minecraft/mc-server:/data'
      - '/etc/localtime:/etc/localtime:ro'

  # "init" container for mc to restore the data volume when empty
  restore-backup:
    # Same image as mc, but any base image with bash and tar will work
    image: 'itzg/mc-backup:latest'
    restart: 'no'
    entrypoint: 'restore-tar-backup'
    volumes:
      # Must be same mount as mc service, needs to be writable
      - './minecraft/mc-server:/data'
      # Must be same mount as backups service, but can be read-only
      - './minecraft/backup:/backups:ro'
      - '/etc/localtime:/etc/localtime:ro'

  backups:
    image: 'itzg/mc-backup:latest'
    depends_on:
      mc:
        condition: 'service_healthy'
    environment:
      BACKUP_INTERVAL: "6h"
      RCON_HOST: 'mc'
      PAUSE_IF_NO_PLAYERS: 'TRUE'
      PLAYERS_ONLINE_CHECK_INTERVAL: '15m'
      PRUNE_BACKUPS_DAYS: 14
      INITIAL_DELAY: 0
    volumes:
      - './minecraft/mc-server:/data:ro'
      - './minecraft/backup:/backups'
      - '/etc/localtime:/etc/localtime:ro'

  monitor:
    image: 'itzg/mc-monitor'
    command: 'export-for-prometheus'
    environment:
      EXPORT_SERVERS: 'mc'
      DEBUG: "true"
    depends_on:
      - 'mc'

  cadvisor:
    image: 'gcr.io/cadvisor/cadvisor:v0.47.2'
    ports:
      - "8180:8080"
    volumes:
      - '/:/rootfs:ro'
      - '/var/run:/var/run:rw'
      - '/sys:/sys:ro'
      - '/var/lib/docker/:/var/lib/docker:ro'

  prometheus:
    image: 'prom/prometheus'
    volumes:
      - './minecraft/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml'
      - 'prometheus-tsdb:/prometheus'
    depends_on:
      - 'monitor'

  grafana:
    image: 'grafana/grafana-oss:${GRAFANA_VERSION:-8.3.3}'
    ports:
      - "3000:3000"
    volumes:
      - 'grafana-lib:/var/lib/grafana'
      - './minecraft/grafana/provisioning:/etc/grafana/provisioning'
      - './minecraft/grafana/dashboards:/etc/grafana/dashboards'
    depends_on:
      - 'prometheus'

  # bluemap:
  #   image: 'bmoorman/bluemap:latest'
  #   restart: 'unless-stopped'
  #   ports:
  #     - "8100:8100"
  #   volumes:
  #     - 'bluemap-data:/var/lib/bluemap'
  #     - './minecraft/mc-server:/var/lib/minecraft:ro'
  #     - '/etc/localtime:/etc/localtime:ro'

volumes:
  prometheus-tsdb: {}
  grafana-lib: {}
  # bluemap-data: {}
